name: Build and Test

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'renovate.json'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'renovate.json'
  release:
    types: [ published ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

concurrency: 
  cancel-in-progress: true
  group: build-${{ github.workflow_sha }}-${{ github.ref }}

env:
  RUNNER_IDLE_TIMEOUT_MINUTES: ${{ vars.RUNNER_IDLE_TIMEOUT_MINUTES || '5' }}
  RUNNER_MAX_RESTARTS: ${{ vars.RUNNER_MAX_RESTARTS || '2' }}
  DOCKER_REPO: ghcr.io/${{ github.repository }}/
  DOCKER_RELEASE_PREFIX_OPT: ${{ github.event_name == 'release' && github.event.release.tag_name || '' }}${{ github.event_name == 'release' && '-' || '' }}

jobs:
  registration-token:
    name: Create Registration Token
    runs-on: ubuntu-latest
    environment: registration
    permissions:
      contents: read
    outputs:
      reg_token: ${{ steps.encoded-reg-token.outputs.out }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Create registration token
        id: token
        shell: bash
        run: |
          if [ -z "${{ secrets.REGISTRATION_PAT }}" ]; then
            echo "REGISTRATION_PAT secret missing" >&2
            exit 1
          fi
          token=$(pwsh -Command ". ./registration.ps1; New-RegistrationToken -PatToken '${{ secrets.REGISTRATION_PAT }}' -RepoFullName '${{ github.repository }}'")
          echo "::add-mask::$token"
          if [ -z "$token" ]; then
            echo "Failed to create registration token" >&2
            exit 1
          fi
          echo "reg_token=$token" >> "$GITHUB_OUTPUT"

      - name: Encode registration token
        id: encoded-reg-token
        shell: pwsh
        env:
          SECRET: ${{ secrets.SYM_ENC }}
          IN: ${{ steps.token.outputs.reg_token }}
        run: |
          $plain = $env:IN
          if (-not $plain) { throw "IN payload missing" }
          $key = [System.Security.Cryptography.SHA256]::HashData([System.Text.Encoding]::UTF8.GetBytes($env:SECRET))
          $aes = [System.Security.Cryptography.Aes]::Create()
          $aes.Mode = 'CBC'
          $aes.Padding = 'PKCS7'
          $aes.Key = $key
          $aes.GenerateIV()
          $encryptor = $aes.CreateEncryptor()
          $plainBytes = [System.Text.Encoding]::UTF8.GetBytes($plain)
          $cipher = $encryptor.TransformFinalBlock($plainBytes, 0, $plainBytes.Length)
          $payload = $aes.IV + $cipher
          $out = [Convert]::ToBase64String($payload)
          "out=$out" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

  build:
    name: Build and Launch Runners (${{ matrix.context }})
    needs: registration-token
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: ubuntu-latest
            context: linux
            platform: linux
            tag: ubuntu
            registry: runner
            buildkit: true
            test: true
          - os: ${{ github.run_attempt > 1 && 'windows-latest' || 'windows-runner-set' }}
            context: windows
            platform: windows
            tag: windows
            registry: runner
            buildkit: ${{ github.run_attempt == 1 }}
            test: true
          - os: ${{ github.run_attempt > 1 && 'windows-latest' || 'windows-runner-set' }}
            context: docker-dind
            platform: windows
            tag: windows
            registry: docker-dind
            buildkit: ${{ github.run_attempt == 1 }}
            test: false
          
    runs-on: ${{ matrix.os }}
    env:
      TEST_TAG: runner-${{ matrix.platform }}-local
      TEST_PROJECT: test-${{ github.run_id }}-${{ matrix.platform }}
      PLATFORMS: ${{ matrix.platform == 'linux' && 'linux/amd64,linux/arm64' || 'windows/amd64' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set up QEMU
        if: matrix.platform == 'linux'
        uses: docker/setup-qemu-action@2b82ce82d56a2a04d2637cd93a637ae1b359c0a7 # v2.2.0
        with:
          platforms: ${{ env.PLATFORMS }}
      
      - name: Set up Docker Buildx
        if: matrix.buildkit
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
        with:
          platforms: ${{ env.PLATFORMS }}
          driver: ${{ matrix.buildkit && 'docker-container' || 'docker' }}

      - name: Build Multi-Arch Docker Image (using Buildx)
        if: matrix.buildkit && matrix.test
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ matrix.context }}
          tags: ${{ env.TEST_TAG }}
          platforms: ${{ env.PLATFORMS }}
          cache-from: type=registry,ref=${{ env.DOCKER_REPO }}${{ matrix.registry }}:buildcache-${{ matrix.platform }}
          cache-to: type=gha,mode=max
      
      - name: Load Docker Image (using Buildx)
        if: matrix.buildkit && matrix.test
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          load: true
          context: ${{ matrix.context }}
          tags: ${{ env.TEST_TAG }}
          cache-from: type=gha
      
      - name: Build Docker Image (without Buildx)
        if: matrix.buildkit == false
        shell: pwsh
        run: |
          docker pull ${{ env.DOCKER_REPO }}${{ matrix.registry }}:${{ matrix.tag }} || echo "No cache platform found"
          docker build -t "${{ env.TEST_TAG }}" ${{ matrix.context }}

      - name: Decode registration token
        id: decoded-reg-token
        if: matrix.test
        shell: pwsh
        env:
          SECRET: ${{ secrets.SYM_ENC }}
          IN: ${{ needs.registration-token.outputs.reg_token }}
        run: |
          $payload = [Convert]::FromBase64String($env:IN)
          if ($payload.Length -lt 17) { throw "IN payload invalid" }
          $iv = $payload[0..15]
          $cipher = $payload[16..($payload.Length-1)]
          $key = [System.Security.Cryptography.SHA256]::HashData([System.Text.Encoding]::UTF8.GetBytes($env:SECRET))
          $aes = [System.Security.Cryptography.Aes]::Create()
          $aes.Mode = 'CBC'
          $aes.Padding = 'PKCS7'
          $aes.Key = $key
          $aes.IV = $iv
          $decryptor = $aes.CreateDecryptor()
          $plainBytes = $decryptor.TransformFinalBlock($cipher, 0, $cipher.Length)
          $plain = [System.Text.Encoding]::UTF8.GetString($plainBytes)
          Write-Output "::add-mask::$plain"
          "out=$plain" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Start runner via launch script
        if: matrix.test
        shell: pwsh
        run: |
          $regToken = "${{ steps.decoded-reg-token.outputs.out }}"
          if (-not $regToken) { throw "REG_TOKEN missing" }
          . ./launch.ps1
          $labels = "self-hosted,${{ matrix.context }},docker,run-${{ github.run_id }}"
          $repoObj = [pscustomobject]@{ full_name = "${{ github.repository }}"; html_url = "https://github.com/${{ github.repository }}" }
          Start-Runner -Repo $repoObj -RegToken $regToken -ComposeProject "${{ env.TEST_PROJECT }}" -Platform "${{ matrix.platform }}" -RunnerIdleTimeoutMinutes $env:RUNNER_IDLE_TIMEOUT_MINUTES -RunnerMaxRestarts $env:RUNNER_MAX_RESTARTS -RunnerLabels $labels -RunnerImage "${{ env.TEST_TAG }}" -RunnerName "${{ env.TEST_PROJECT }}" -WithWsl:$false

      - name: Ensure runner container is running
        if: matrix.test
        shell: pwsh
        run: |
          $deadline = (Get-Date).AddMinutes(2)
          $state = $null
          $containerId = $null

          function Get-ContainerId {
              param([string]$Project)
              $id = docker ps --filter "label=com.docker.compose.project=$Project" --format "{{.ID}}" | Select-Object -First 1
              if (-not $id) {
                  $id = docker ps -a --filter "label=com.docker.compose.project=$Project" --format "{{.ID}}" | Select-Object -First 1
              }
              return $id
          }

          while ((Get-Date) -lt $deadline) {
              $containerId = Get-ContainerId -Project "${{ env.TEST_PROJECT }}"
              if (-not $containerId) {
                  Start-Sleep -Seconds 5
                  continue
              }

              $stateJson = docker inspect --format "{{json .State}}" $containerId 2>$null
              if ($LASTEXITCODE -ne 0 -or -not $stateJson) {
                  Start-Sleep -Seconds 5
                  continue
              }
              $state = $stateJson | ConvertFrom-Json
              if ($state.Running) {
                  Write-Host "✅ Runner container '$containerId' is running."
                  break
              }
              if ($state.Status -eq "exited") {
                  Write-Host "ℹ️ Container exited early. State: $(ConvertTo-Json $state -Compress)"
                  docker logs $containerId
                  throw "Runner container exited with code $($state.ExitCode)."
              }
              Start-Sleep -Seconds 5
          }
          if (-not $state -or -not $state.Running) {
              if ($state) { Write-Host "ℹ️ Final container state: $(ConvertTo-Json $state -Compress)" }
              if ($containerId) { docker logs $containerId }
              throw "Runner container for project '${{ env.TEST_PROJECT }}' did not reach running state before timeout."
          }

      - name: Check runner logs for readiness
        if: matrix.test
        shell: pwsh
        run: |
          function Get-ContainerId {
              param([string]$Project)
              $id = docker ps --filter "label=com.docker.compose.project=$Project" --format "{{.ID}}" | Select-Object -First 1
              if (-not $id) {
                  $id = docker ps -a --filter "label=com.docker.compose.project=$Project" --format "{{.ID}}" | Select-Object -First 1
              }
              return $id
          }

          $containerId = Get-ContainerId -Project "${{ env.TEST_PROJECT }}"
          if (-not $containerId) { throw "No container found for project '${{ env.TEST_PROJECT }}'." }

          $deadline = (Get-Date).AddMinutes(2)
          $ready = $false
          while ((Get-Date) -lt $deadline) {
              $logs = docker logs $containerId 2>$null
              if ($logs -match "Listening for jobs") {
                  $ready = $true
                  break
              }
              Start-Sleep -Seconds 5
          }

          Write-Host "===== runner logs ($containerId) ====="
          docker logs $containerId
          Write-Host "======================================"

          if (-not $ready) {
              throw "Runner container '$containerId' did not log readiness ('Listening for jobs')."
          }

      - name: Wait for self-hosted jobs
        if: matrix.test
        uses: yogeshlonkar/wait-for-jobs@3244ca00e7afdbaa306c62813ee95f371bdff93e # v0.4.9
        with:
          jobs: "Integrated Runner Test (${{ matrix.context }})"
          ignore-skipped: 'false'
          ttl: '2'

      - name: Push Docker Image (with Buildx)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        if: matrix.buildkit && (github.event_name == 'release' || github.event_name == 'push' || github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.ref_name == 'main'))
        env:
          REGISTRY_REF: registry,ref=${{ env.DOCKER_REPO }}${{ matrix.registry }}:buildcache-${{ matrix.platform }}
        with:
          push: true
          context: ${{ matrix.context }}
          tags: "${{ env.DOCKER_REPO }}${{ matrix.registry }}:${{ env.DOCKER_RELEASE_PREFIX_OPT }}${{ matrix.tag }}"
          platforms: ${{ env.PLATFORMS }}
          cache-from: type=${{ matrix.test && 'gha' || env.REGISTRY_REF }}
          cache-to: type=${{ env.REGISTRY_REF }},mode=max
          
      - name: Push Docker Image (without Buildx)
        if: matrix.buildkit == false && (github.event_name == 'release' || github.event_name == 'push' || github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.ref_name == 'main'))
        env:
          RELEASE_TAG: "${{ env.DOCKER_REPO }}${{ matrix.registry }}:${{ env.DOCKER_RELEASE_PREFIX_OPT }}${{ matrix.tag }}"
        run: |
          docker tag "${{ env.TEST_TAG }}" "${{ env.RELEASE_TAG }}"
          docker push "${{ env.RELEASE_TAG }}"

  cancel-on-failure:
    name: Cancel on Build Failure
    needs: build
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cancel workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh run cancel ${{ github.run_id }}

  test:
    name: Integrated Runner Test
    needs: registration-token
    environment: testing
    permissions:
      contents: none
    strategy:
      matrix:
        include:
          - platform: linux
          - platform: windows
    runs-on:
      - self-hosted
      - ${{ matrix.platform }}
      - run-${{ github.run_id }}
    timeout-minutes: 5
    steps:
      - run: echo "Self-hosted runner alive on ${{ matrix.platform }}"

  merge:
    name: Merge Manifest
    needs: [build, test]
    if: github.event_name == 'release' || github.event_name == 'push' || github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.ref_name == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      DOCKER_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || 'latest' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Merge multi-platform images
        run: |
          docker buildx imagetools create \
            -t ${{ env.DOCKER_REPO }}runner:${{ env.DOCKER_TAG }} \
            ${{ env.DOCKER_REPO }}runner:${{ env.DOCKER_RELEASE_PREFIX_OPT }}ubuntu \
            ${{ env.DOCKER_REPO }}runner:${{ env.DOCKER_RELEASE_PREFIX_OPT }}windows

  tag:
    name: Additional Tagging
    needs: build
    if: github.event_name == 'release' || github.event_name == 'push' || github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.ref_name == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      DOCKERD_VERSION: 28.3.1
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Tag docker-dind image
        env:
          DOCKER_TAG: ${{ github.event_name == 'release' && env.DOCKERD_VERSION || 'latest' }}
        run: |
          docker buildx imagetools create \
            -t "${{ env.DOCKER_REPO }}docker-dind:${{ env.DOCKER_TAG }}" \
            "${{ env.DOCKER_REPO }}docker-dind:${{ env.DOCKER_RELEASE_PREFIX_OPT }}windows"


  lint-charts:
    name: Test Helm Charts
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.13'
          check-latest: true

      - name: Set up chart testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: Run chart linting
        run: ct lint ${{ github.event != 'pull_request' && '--all' }}

  release-charts:
    name: Release Helm Charts
    needs: lint-charts
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.ref_name == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    environment: connect
    env:
      CR_PASSPHRASE_FILE: ${{ vars.CR_KEYDIR }}/passphrase
      CR_KEYRING: ${{ vars.CR_KEYDIR }}/secring.gpg
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Load Secrets
        uses: 1password/load-secrets-action@13f58eec611f8e5db52ec16247f58c508398f3e6 # v3.0.0
        id: load-secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CR_KEYFILE: ${{ vars.CR_KEYFILE }}
          CR_PASSPHRASE: ${{ vars.CR_PASSPHRASE }}

      - name: Prepare GPG Keyring
        run: |
          mkdir -pv ${{ vars.CR_KEYDIR }}
          base64 -d <<< "${{ steps.load-secrets.outputs.CR_KEYFILE }}" > "${{ env.CR_KEYRING }}"
          echo "${{ steps.load-secrets.outputs.CR_PASSPHRASE }}" > "${{ env.CR_PASSPHRASE_FILE }}"

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@a917fd15b20e8b64b94d9158ad54cd6345335584 # v1.6.0
        with:
          charts_dir: charts
          config: cr.yaml
        env:
          CR_TOKEN: ${{ github.token }}
          CR_SIGN: true

  complete:
    name: Complete Workflow
    needs:
      - cleanup-runners
      - build
      - lint-charts
      - merge
      - tag
    if: always()
    environment: completion
    runs-on: ubuntu-latest
    permissions:
      contents: none
    steps:
      - name: Check dependent job results
        shell: bash
        run: |
          # Fail only on explicit failures/cancellations, ignore skipped jobs
          if [ "${{ needs.build.result }}" = "failure" ] || [ "${{ needs.build.result }}" = "cancelled" ]; then
            echo "build -> ${{ needs.build.result }}"
            exit 1
          fi
          if [ "${{ needs.lint-charts.result }}" = "failure" ] || [ "${{ needs.lint-charts.result }}" = "cancelled" ]; then
            echo "lint-charts -> ${{ needs.lint-charts.result }}"
            exit 1
          fi
          if [ "${{ needs.merge.result }}" = "failure" ] || [ "${{ needs.merge.result }}" = "cancelled" ]; then
            echo "merge -> ${{ needs.merge.result }}"
            exit 1
          fi
          if [ "${{ needs.tag.result }}" = "failure" ] || [ "${{ needs.tag.result }}" = "cancelled" ]; then
            echo "tag -> ${{ needs.tag.result }}"
            exit 1
          fi
          if [ "${{ needs.cleanup-runners.result }}" = "failure" ] || [ "${{ needs.cleanup-runners.result }}" = "cancelled" ]; then
            echo "cleanup-runners -> ${{ needs.cleanup-runners.result }}"
            exit 1
          fi
          echo "No failed dependents (skipped jobs ignored)."

  cleanup-runners:
    name: Cleanup Runners
    needs: [build, test]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: registration
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Delete self-hosted runners for this run
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.REGISTRATION_PAT }}
          RUNNER_NAMES: "test-${{ github.run_id }}-linux,test-${{ github.run_id }}-windows"
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          if (-not $env:PAT_TOKEN) { throw "PAT_TOKEN (REGISTRATION_PAT) is required for cleanup." }
          ./cleanup-runners.ps1 -RepoFullName $env:REPO_FULL_NAME -PatToken $env:PAT_TOKEN -RunnerNames ($env:RUNNER_NAMES -split ",")
